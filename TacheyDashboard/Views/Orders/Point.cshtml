
@{
    ViewData["Title"] = "積分管理";

}

<div class="" id="app">

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item w-50 text-center" role="presentation">
            <a class="nav-link active fs-4 fw-bold" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">
                <i class="far fa-clipboard"></i>
                未發送積分
            </a>
        </li>
        <li class="nav-item w-50 text-center" role="presentation">
            <a class="nav-link fs-4 fw-bold" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">
                <i class="fas fa-clipboard-check"></i>
                已發送積分
            </a>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane bg-white fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
            <b-button variant="outline-danger" class="mt-3 ml-3" v-b-modal.modal-1><i class="far fa-plus-square mr-2"></i>新增積分券</b-button>
            <template>
                <div>
                    <b-table :items="unPoints" :busy="isBusy" :fields="unfields" class="mt-3" hover :head-variant="headVariant" :fixed="fixed" :filter="filter" :filter-included-fields="filterOn" :current-page="uncurrentPage" :per-page="perPage">
                        <template #table-busy>
                            <div class="text-center text-danger my-2">
                                <b-spinner class="align-middle"></b-spinner>
                                <strong>Loading...</strong>
                            </div>
                        </template>
                        <template #cell(status)="row">
                            <b-button v-on:click="info(row.item, row.index, $event.target)" class="mr-1" variant="warning">
                                未發送
                            </b-button>
                        </template>
                        <template #cell(editor)="row">
                            <b-button v-on:click="infoEdit(row.item, row.index, $event.target)" class="mr-1" variant="primary">
                                編輯
                            </b-button>
                            @*<b-button v-on:click="infoDel(row.item, row.index, $event.target)" class="mr-1" variant="danger">
                                刪除
                            </b-button>*@
                        </template>
                    </b-table>
                </div>
            </template>
            <b-pagination v-model="uncurrentPage"
                          :total-rows="untotalRows"
                          :per-page="perPage"
                          align="center"
                          class="my-0">
            </b-pagination>
        </div>
        <div class="tab-pane bg-white fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
            <template>
                <div>
                    <b-table :items="Points" :busy="isBusy" :fields="fields" class="mt-3" hover :head-variant="headVariant" :fixed="fixed" :filter="unFilter" :filter-included-fields="filterOn" :current-page="currentPage" :per-page="perPage">
                        <template #table-busy>
                            <div class="text-center text-danger my-2">
                                <b-spinner class="align-middle"></b-spinner>
                                <strong>Loading...</strong>
                            </div>
                        </template>
                        <template #cell(status)="row">
                            <b-button v-on:click="info(row.item, row.index, $event.target)" class="mr-1" disabled>
                                已發送
                            </b-button>
                        </template>
                    </b-table>
                </div>
            </template>
            <b-pagination v-model="currentPage"
                          :total-rows="totalRows"
                          :per-page="perPage"
                          align="center"
                          class="my-0">
            </b-pagination>
        </div>
    </div>

    @*新增積分券*@
    <b-modal id="modal-1" title="新增積分券">

        <b-form-group id="input-group-1" label="積分類別:" label-for="input-1">
            <b-form-select v-model="PointForm.pointName" :options="options"></b-form-select>
        </b-form-group>

        <b-form-group id="input-group-2" label="積分點數:" label-for="input-2">
            <b-form-input id="input-2"
                          v-model="PointForm.pointNum"
                          placeholder="輸入點數"
                          required
                          :type="type"></b-form-input>
        </b-form-group>

        <b-form-group id="input-group-3" label="積分期限:" label-for="input-3">
            <b-form-input id="input-3"
                          v-model="PointForm.validDate"
                          placeholder="輸入期限"
                          required
                          :type="type"></b-form-input>
        </b-form-group>

        <template #modal-footer="{ ok, cancel }">
            <b-button variant="danger" v-on:click="cancel()">
                取消
            </b-button>
            <b-button variant="success" v-on:click="ok();postPoint()">
                新增
            </b-button>
        </template>
    </b-modal>

    @*發送積分券*@
    <b-modal :id="infoModal.id" :title="infoModal.title" v-on:hide="resetInfoModal">
        <pre class="fs-3">{{ infoModal.content }}</pre>
        <template #modal-footer="{ ok, cancel }">
            <b-button variant="secondary" v-on:click="cancel()">
                取消
            </b-button>
            <b-button variant="warning" v-on:click="ok();sendPoint(infoModal.pointId)">
                發送
            </b-button>
        </template>
    </b-modal>

    @*更新積分券*@
    <b-modal :id="infoModalEdit.id" :title="infoModalEdit.title" v-on:hide="resetInfoModal">

        <b-form-group id="input-group-1" label="積分類別:" label-for="input-1">
            <b-form-select v-model="UpdateForm.pointName" :options="options"></b-form-select>
        </b-form-group>

        <b-form-group id="input-group-2" label="積分點數:" label-for="input-2">
            <b-form-input id="input-2"
                          v-model="UpdateForm.pointNum"
                          placeholder="輸入點數"
                          required
                          :type="type"></b-form-input>
        </b-form-group>

        <b-form-group id="input-group-3" label="積分期限:" label-for="input-3">
            <b-form-input id="input-3"
                          v-model="UpdateForm.validDate"
                          placeholder="輸入期限"
                          required
                          :type="type"></b-form-input>
        </b-form-group>

        <template #modal-footer="{ ok, cancel }">
            <b-button variant="secondary" v-on:click="cancel()">
                取消
            </b-button>
            <b-button variant="primary" v-on:click="ok();updatePoint(infoModalEdit.pointId)">
                更新
            </b-button>
        </template>
    </b-modal>

    @*刪除積分券*@
    <b-modal :id="infoModalDel.id" :title="infoModalDel.title" v-on:hide="resetInfoModal">
        <pre class="fs-3">{{ infoModalDel.content }}</pre>
        <template #modal-footer="{ ok, cancel }">
            <b-button variant="secondary" v-on:click="cancel()">
                取消
            </b-button>
            <b-button variant="danger" v-on:click="ok();deletePoint(infoModalDel.pointId)">
                刪除
            </b-button>
        </template>
    </b-modal>

</div>

@section endJS{
    <script>
        let app = new Vue({
            el: '#app',
            data() {
                return {
                    isBusy: false,
                    headVariant: 'dark',
                    fixed: true,
                    filter: 'false',
                    unFilter: 'true',
                    filterOn: ['status'],
                    totalRows: 1,
                    currentPage: 1,
                    untotalRows: 1,
                    uncurrentPage: 1,
                    perPage: 8,
                    Points: [],
                    unPoints: [],
                    unfields: [
                        { key: 'pointId', label: '積分編號', sortable: true },
                        { key: 'pointName', label: '積分名稱', sortable: true },
                        { key: 'pointNum', label: '點數', sortable: true },
                        { key: 'validDate', label: '有效天數', sortable: true },
                        { key: 'status', label: '發送狀態' },
                        { key: 'editor', label: '積分管理' }
                    ],
                    fields: [
                        { key: 'pointId', label: '積分編號', sortable: true },
                        { key: 'pointName', label: '積分名稱', sortable: true },
                        { key: 'pointNum', label: '點數', sortable: true },
                        { key: 'validDate', label: '有效天數', sortable: true },
                        { key: 'getTime', label: '發送日期', sortable: true },
                        { key: 'deadLine', label: '結束日期', sortable: true },
                        { key: 'status', label: '發送狀態' }
                    ],
                    type: 'number',
                    PointForm: {
                        pointName: '',
                        pointNum: 0,
                        validDate: 0
                    },
                    UpdateForm: {},
                    infoModal: {
                        id: 'info-modal',
                        title: '',
                        content: '',
                        pointId: null
                    },
                    infoModalEdit: {
                        id: 'info-modal-edit',
                        title: '',
                        content: ''
                    },
                    infoModalDel: {
                        id: 'info-modal-del',
                        title: '',
                        content: '',
                        pointId: null
                    },
                    options: [
                        { value: '每日登入', text: '每日登入' },
                        { value: '周末好禮', text: '周末好禮' },
                        { value: '節日放送', text: '節日放送' }
                    ]
                }
            },
            mounted() {
                axios.get('https://localhost:44363/api/Point')
                    .then((res) => {
                        this.isBusy = !this.isBusy
                        res.data.result.forEach((item) => {
                            if (item.status == true) {
                                this.Points.push({
                                    'pointId': item.pointId,
                                    'pointName': item.pointName,
                                    'pointNum': item.pointNum,
                                    'validDate': item.validDate,
                                    'status': item.status,
                                    'getTime': item.getTime,
                                    'deadLine': item.deadline
                                })
                            } else {
                                this.unPoints.push({
                                    'pointId': item.pointId,
                                    'pointName': item.pointName,
                                    'pointNum': item.pointNum,
                                    'validDate': item.validDate,
                                    'status': item.status
                                })
                            }
                        })
                        this.isBusy = !this.isBusy
                        this.totalRows = this.Points.length
                        this.untotalRows = this.unPoints.length
                    })
            },
            methods: {
                toggleBusy() {
                    this.isBusy = !this.isBusy
                },
                info(item, index, button) {
                    this.infoModal.title = `${item.pointId}號-積分券`
                    this.infoModal.content = `確定發送${item.pointId}號積分券?`
                    this.$root.$emit('bv::show::modal', this.infoModal.id, button)
                    this.infoModal.pointId = item.pointId
                },
                infoEdit(item, index, button) {
                    this.infoModalEdit.title = `編輯 ${item.pointId}號-積分券`
                    this.infoModalEdit.content = `確定編輯${item.pointId}號積分券?`
                    this.$root.$emit('bv::show::modal', this.infoModalEdit.id, button)
                   
                    this.UpdateForm = {
                        pointId: item.pointId,
                        pointName: item.pointName,
                        pointNum: item.pointNum,
                        validDate: item.validDate
                    }
                },
                infoDel(item, index, button) {
                    this.infoModalDel.title = `${item.pointId}號-積分券`
                    this.infoModalDel.content = `確定刪除${item.pointId}號積分券?`
                    this.$root.$emit('bv::show::modal', this.infoModalDel.id, button)
                    this.infoModalDel.pointId = item.pointId
                },
                resetInfoModal() {
                    this.infoModal.title = ''
                    this.infoModal.content = ''
                },
                sendPoint(id) {
                    axios.patch(`https://localhost:44363/api/Point/${id}`)
                        .then((res) => {
                            var result = this.unPoints.find((item) => {
                                return item.pointId == id
                            });
                            this.unPoints.splice(this.unPoints.indexOf(result), 1)
                            this.Points.push({
                                'pointId': res.data.result.pointId,
                                'pointName': res.data.result.pointName,
                                'pointNum': res.data.result.pointNum,
                                'validDate': res.data.result.validDate,
                                'status': res.data.result.status,
                                'getTime': res.data.result.getTime,
                                'deadLine': res.data.result.deadline
                            });
                            this.totalRows = this.Points.length
                            this.untotalRows = this.unPoints.length
                        })
                },
                postPoint() {
                    axios.post('https://localhost:44363/api/Point', {
                        pointName: this.PointForm.pointName,
                        pointNum: parseInt(this.PointForm.pointNum),
                        validDate: parseInt(this.PointForm.validDate)
                    }).then((res) => {
                        this.unPoints.push({
                            'pointId': res.data.result.pointId,
                            'pointName': res.data.result.pointName,
                            'pointNum': res.data.result.pointNum,
                            'validDate': res.data.result.validDate,
                            'status': res.data.result.status
                        })
                        this.PointForm = {
                            pointName: '',
                            pointNum: 0,
                            validDate: 0
                        }
                        this.totalRows = this.Points.length
                        this.untotalRows = this.unPoints.length
                    })
                },
                updatePoint() {
                    var result = {
                        pointId: this.UpdateForm.pointId,
                        pointName: this.UpdateForm.pointName,
                        pointNum: parseInt(this.UpdateForm.pointNum),
                        validDate: parseInt(this.UpdateForm.validDate)
                    }
                    console.warn(result)
                    axios.put('https://localhost:44363/api/Point', result).then(res => {
                        var index = this.unPoints.findIndex(item => item.pointId == result.pointId)
                        this.unPoints[index].pointName = result.pointName
                        this.unPoints[index].pointNum = result.pointNum
                        this.unPoints[index].validDate = result.validDate
                    })
                },
                deletePoint(id) {
                    axios.delete(`https://localhost:44363/api/Point/${id}`)
                        .then(res => {

                        })
                }
            }
        })
    </script>
}

@*<script>
        let app = new Vue({
            el: '#app',
            data: {
                items: @Html.Raw(ViewBag.jsonString),
                fields: [
                    { key: 'PointId', label: 'PointId', sortable: true, sortDirection: 'desc' },
                    { key: 'MemberId', label: 'MemberId', sortable: true, sortDirection: 'desc' },
                    { key: 'PointName', label: 'PointName', sortable: true, sortDirection: 'desc'},
                    { key: 'PointNum', label: 'PointNum', sortable: true, sortDirection: 'desc'},
                    { key: 'GetTime', label: 'GetTime', sortable: true, sortDirection: 'desc'},
                    { key: 'Deadline', label: 'Deadline', sortable: true, sortDirection: 'desc' },
                    { key: 'Status', label: 'Status', sortable: true, sortDirection: 'desc' }
                ],
                totalRows: 1,
                currentPage: 1,
                perPage: 5,
                pageOptions: [5, 10, 15, { value: 100, text: "Show a lot" }],
                sortBy: '',
                sortDesc: false,
                sortDirection: 'asc',
                filter: null,
                filterOn: [],
                infoModal: {
                    id: 'info-modal',
                    title: '',
                    content: ''
                }
            },
            computed: {
                sortOptions() {
                    // Create an options list from our fields
                    return this.fields
                        .filter(f => f.sortable)
                        .map(f => {
                            return { text: f.label, value: f.key }
                        })
                }
            },
            mounted() {
                // Set the initial number of items
                this.totalRows = this.items.length
            },
            methods: {
                info(item, index, button) {
                    this.infoModal.title = `Row index: ${index}`
                    this.infoModal.content = JSON.stringify(item, null, 2)
                    this.$root.$emit('bv::show::modal', this.infoModal.id, button)
                },
                resetInfoModal() {
                    this.infoModal.title = ''
                    this.infoModal.content = ''
                },
                onFiltered(filteredItems) {
                    // Trigger pagination to update the number of buttons/pages due to filtering
                    this.totalRows = filteredItems.length
                    this.currentPage = 1
                }
            }
        });

    </script>*@
